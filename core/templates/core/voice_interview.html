{% extends 'core/base.html' %}

{% block content %}
<div style="text-align: center; padding: 30px;">
    <h2>🎤 AI Voice Interview Practice</h2>

    <!-- Select Interview Level -->
    <div style="margin-top: 20px;">
        <label for="level-select"><strong>Select Interview Level:</strong></label>
        <select id="level-select" onchange="fetchQuestion()" style="padding: 8px; margin-left: 10px;">
            <option value="">--Choose Level--</option>
            <option value="easy">Easy</option>
            <option value="medium">Medium</option>
            <option value="hard">Hard</option>
        </select>
    </div>

    <!-- Display Question -->
    <div id="question-area" style="margin-top: 30px;">
        <h3 id="question-text">Your Question will appear here...</h3>
    </div>

    <!-- Voice Recording -->
    <div style="margin-top: 40px;">
        <h3>🎤 Your Answer (Voice Recording)</h3>
        <button id="start-btn" onclick="startRecording()">🎙️ Start Recording</button>
        <button id="stop-btn" onclick="stopRecording()" disabled>🛑 Stop Recording</button>
        <button id="quit-btn" onclick="quitInterview()" style="display: none;">❌ Quit Interview</button>
        <p id="recording-status" style="margin-top: 20px; font-weight: bold;"></p>

        <audio id="audio-playback" controls style="margin-top: 20px; display: none;"></audio>
    </div>

    <!-- Answer Textarea & Submit -->
    <div style="margin-top: 30px;">
        <form id="answer-form">
            {% csrf_token %}
            <input type="hidden" name="question" id="hidden-question">
            <input type="hidden" name="level" id="hidden-level">
            <textarea id="answer" name="answer" placeholder="🎙️ Speak your answer or type it here..." rows="6" style="width: 80%; padding: 10px;" required></textarea><br><br>
            <button type="submit" style="padding: 10px 20px; font-size: 16px;">Submit Answer</button>
        </form>
    </div>

    <div id="feedback-box" 
     style="
       margin-top: 20px; 
       font-weight: bold; 
       padding: 15px; 
       border-radius: 8px; 
       background: linear-gradient(135deg, #ff7e5f, #feb47b); 
       color: #4a2c2a; 
       box-shadow: 0 4px 8px rgba(255, 126, 95, 0.5);
       font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
       text-align: center;
       transition: background 0.3s ease;
     ">
  <!-- Feedback messages will appear here -->
</div>



    <!-- Post-answer options -->
    <div id="post-options" style="margin-top: 20px; display: none;">
        <button onclick="fetchQuestion()" style="margin: 5px; padding: 10px 15px;">🔄 Ask Another Question</button>
        <button onclick="downloadPDF()" style="margin: 5px; padding: 10px 15px;">📄 Download PDF Report</button>
        <button onclick="quitInterview()" style="margin: 5px; padding: 10px 15px;">❌ Quit</button>
    </div>

    <!-- Django Messages -->
    {% if messages %}
      <div id="message-box" style="margin-top:20px;">
        {% for message in messages %}
          <div class="alert alert-success">{{ message }}</div>
        {% endfor %}
      </div>
      <script>
        setTimeout(() => {
          const msgBox = document.getElementById("message-box");
          if (msgBox) msgBox.style.display = 'none';
        }, 3000);
      </script>
    {% endif %}
</div>

<!-- Scripts -->
<script>
let mediaRecorder;
let audioChunks = [];
let timerInterval;
let seconds = 0;
let continueInterview = false;

function fetchQuestion() {
    const level = document.getElementById('level-select').value;
    const questionTextElement = document.getElementById('question-text');

    if (!level) {
        questionTextElement.innerText = "Your Question will appear here...";
        return;
    }

    questionTextElement.innerText = "🤖 Thinking of a good question for you...";

    fetch(`/get_question/${level}/`)
        .then(response => response.json())
        .then(data => {
            const questionText = data.question;
            setTimeout(() => {
                questionTextElement.innerText = questionText;
                document.getElementById('hidden-question').value = questionText;
                document.getElementById('hidden-level').value = level;
                document.getElementById('answer').value = "";
                continueInterview = true;
                document.getElementById('quit-btn').style.display = 'inline-block';
                document.getElementById('post-options').style.display = 'none';
                clearFeedback();
                speakQuestion(questionText);
            }, 1000);
        })
        .catch(error => {
            questionTextElement.innerText = "⚠️ Could not load the question.";
            console.error('Error fetching question:', error);
        });
}

function speakQuestion(text) {
    const synth = window.speechSynthesis;
    const utter = new SpeechSynthesisUtterance(text);
    synth.speak(utter);
}

function startRecording() {
    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();
            document.getElementById('recording-status').innerText = "Recording... 🎙️ 00:00";
            document.getElementById('stop-btn').disabled = false;
            document.getElementById('start-btn').disabled = true;

            startTimer();

            audioChunks = [];
            mediaRecorder.addEventListener("dataavailable", event => {
                audioChunks.push(event.data);
            });

            mediaRecorder.addEventListener("stop", () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = document.getElementById('audio-playback');
                audio.src = audioUrl;
                audio.style.display = "block";
                stopTimer();
                uploadAudio(audioBlob);
            });
        })
        .catch(err => {
            alert("Error accessing microphone: " + err.message);
        });
}

function stopRecording() {
    if (mediaRecorder) {
        mediaRecorder.stop();
        document.getElementById('recording-status').innerText = "Recording Stopped ✅";
        document.getElementById('stop-btn').disabled = true;
        document.getElementById('start-btn').disabled = false;
    }
}

function quitInterview() {
    continueInterview = false;
    document.getElementById('question-text').innerText = "🎉 Interview Ended! Thanks for participating.";
    document.getElementById('quit-btn').style.display = 'none';
    document.getElementById('recording-status').innerText = "";
    document.getElementById('post-options').style.display = 'none';
}

function startTimer() {
    seconds = 0;
    timerInterval = setInterval(() => {
        seconds++;
        const mins = String(Math.floor(seconds / 60)).padStart(2, '0');
        const secs = String(seconds % 60).padStart(2, '0');
        document.getElementById('recording-status').innerText = `Recording... 🎙️ ${mins}:${secs}`;
    }, 1000);
}

function stopTimer() {
    clearInterval(timerInterval);
}

function uploadAudio(audioBlob) {
    const formData = new FormData();
    formData.append('audio', audioBlob);
    formData.append('question', document.getElementById('hidden-question').value);
    formData.append('level', document.getElementById('hidden-level').value);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch("{% url 'submit_audio_answer' %}", {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.transcript) {
            document.getElementById('answer').value = data.transcript;
        }
        if (data.feedback) {
            document.getElementById('feedback-box').innerText = "🎯 Feedback: " + data.feedback;
        } else {
            document.getElementById('feedback-box').innerText = "⚠️ Could not get feedback.";
        }
        document.getElementById('post-options').style.display = 'block';
    })
    .catch(err => {
        console.error("Audio feedback error:", err);
        document.getElementById('feedback-box').innerText = "⚠️ Error fetching feedback.";
    });
}

function clearFeedback() {
    document.getElementById('feedback-box').innerText = '';
    document.getElementById('post-options').style.display = 'none';
}

function downloadPDF() {
    const question = document.getElementById('hidden-question').value;
    const answer = document.getElementById('answer').value;
    const feedback = document.getElementById('feedback-box').innerText;

    const docContent = `Interview Question:\n${question}\n\nYour Answer:\n${answer}\n\n${feedback}`;

    const blob = new Blob([docContent], { type: "application/pdf" });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'Interview_Report.pdf';
    link.click();
}

// Handle text answer form submission via AJAX
document.getElementById('answer-form').addEventListener('submit', function(e) {
    e.preventDefault();  // Prevent form redirect

    const answer = document.getElementById('answer').value.trim();
    const question = document.getElementById('hidden-question').value;
    const level = document.getElementById('hidden-level').value;

    if (!answer) {
        alert("Please enter your answer before submitting.");
        return;
    }

    const csrfToken = this.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch("{% url 'submit_text_answer' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            question: question,
            answer: answer,
            level: level
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.feedback) {
            document.getElementById('feedback-box').innerText = "🎯 Feedback: " + data.feedback;
        } else {
            document.getElementById('feedback-box').innerText = "⚠️ Could not get feedback.";
        }
        document.getElementById('post-options').style.display = 'block';
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('feedback-box').innerText = "⚠️ Error submitting answer.";
    });
});
</script>

{% endblock %}
